# ⚠️ 协同光标功能实现说明

## 问题分析

在实现多人协同编辑的光标显示功能时，遇到以下关键问题：

### 错误信息

```
Key "extensions": Expected an array.
WrapperError at @umoteam_editor.js
```

### 根本原因

**开源版 Umo Editor（@umoteam/editor@8.1.0）不支持通过配置直接启用协同光标功能。**

虽然 Umo Editor 内置了 Tiptap 的 `@tiptap/extension-collaboration` 扩展，但：

1. **开源版限制**：开源版 Umo Editor 没有提供配置项来启用协同光标
2. **配置格式错误**：尝试通过 `extensions` 对象传递配置时，Umo Editor 期望的是数组格式，而不是对象
3. **功能分级**：协同光标是商业功能，需要使用 **Umo Editor Next（商业版）**

## 当前实现状态

### ✅ 已实现的功能

1. **基础协同编辑**

   - 多用户可以同时编辑文档
   - 文本内容实时同步
   - 使用 Y.js + WebSocket 实现

2. **用户感知（Awareness）**

   - 右侧协同面板显示在线用户列表
   - 实时更新用户加入/离开状态
   - 每个用户有随机生成的用户名和颜色

3. **连接管理**
   - WebSocket 连接状态显示
   - 自动重连机制
   - 连接状态提示

### ❌ 未实现的功能

**协同光标显示**（需要商业版或其他方案）

- 无法看到其他用户的光标位置
- 无法看到光标上方的用户名标签
- 无法显示用户选中的文本范围

## 解决方案

### 方案一：升级到商业版 Umo Editor Next（推荐）

**Umo Editor Next** 是商业版本，完整支持协同编辑功能：

```javascript
// Umo Editor Next 配置示例
const editorOptions = {
  document: {
    id: 'your-document-id' // 文档 ID，必填
  },
  collaboration: {
    enabled: true,
    provider: {
      url: 'wss://your-hocuspocus-server' // Hocuspocus 服务器地址
      // 其他配置...
    }
  }
}
```

**优势：**

- ✅ 官方支持，稳定可靠
- ✅ 完整的协同光标功能
- ✅ 包含更多企业级功能（文档批注、历史版本、AI 创作等）
- ✅ 技术支持和文档齐全

**获取方式：**

- 访问：https://umodoc.com/
- 查看定价：https://dev.umodoc.com/cn/docs/next/getting-started
- 联系购买商业许可

### 方案二：使用纯 Tiptap + Y.js 实现（开源方案）

如果需要继续使用开源方案，可以不使用 Umo Editor，改用纯 Tiptap：

```bash
# 安装依赖
pnpm add @tiptap/vue-3 @tiptap/starter-kit
pnpm add @tiptap/extension-collaboration @tiptap/extension-collaboration-cursor
pnpm add yjs y-websocket
```

```vue
<template>
  <editor-content :editor="editor" />
</template>

<script setup>
import { useEditor, EditorContent } from '@tiptap/vue-3'
import StarterKit from '@tiptap/starter-kit'
import Collaboration from '@tiptap/extension-collaboration'
import CollaborationCursor from '@tiptap/extension-collaboration-cursor'
import * as Y from 'yjs'
import { WebsocketProvider } from 'y-websocket'

const ydoc = new Y.Doc()
const provider = new WebsocketProvider('ws://localhost:3001', 'demo-doc', ydoc)

const editor = useEditor({
  extensions: [
    StarterKit,
    Collaboration.configure({
      document: ydoc
    }),
    CollaborationCursor.configure({
      provider: provider,
      user: {
        name: '用户名',
        color: '#409EFF'
      }
    })
  ]
})
</script>
```

**优势：**

- ✅ 完全开源免费
- ✅ 支持协同光标
- ✅ 灵活可定制

**劣势：**

- ❌ 失去 Umo Editor 的丰富功能
- ❌ UI 需要自己实现
- ❌ 需要更多开发工作

### 方案三：混合方案（权宜之计）

保留 Umo Editor 用于编辑，通过其他方式展示用户位置：

1. **用户位置指示器**

   - 在编辑器右侧显示用户列表
   - 点击用户名滚动到其编辑位置（通过 awareness 数据）
   - 使用颜色条或高亮显示用户活动区域

2. **实时活动日志**
   - 显示"用户 A 正在编辑第 X 段"
   - 显示最近的编辑操作
   - 提供"跟随用户"功能

**代码示例：**

```vue
<template>
  <div class="collaboration-panel">
    <div v-for="user in collaborators" :key="user.clientId" class="user-item">
      <div class="user-color" :style="{ backgroundColor: user.color }"></div>
      <span>{{ user.name }}</span>
      <span v-if="user.currentLine" class="user-position">
        编辑: 第 {{ user.currentLine }} 行
      </span>
    </div>
  </div>
</template>
```

## 当前代码状态

已修复配置错误，编辑器可以正常渲染：

### 修改内容

1. **移除错误的 extensions 配置**

   - 删除了对象格式的 extensions 配置
   - 恢复为简单的编辑器配置

2. **简化代码**

   - 移除了 `isCollaborationReady` 状态
   - 移除了不必要的配置函数
   - 保留基础的 Y.js 协同编辑功能

3. **保持现有功能**
   - WebSocket 连接正常
   - 文本同步正常
   - 用户列表显示正常

##升级建议

### 短期（1-2 周）

**选择方案三：混合方案**

实现用户位置提示功能，虽然不是真正的光标，但能让用户知道其他人在编辑哪里：

```typescript
// 在 awareness 中添加光标位置信息
provider.awareness.setLocalStateField('user', {
  name: currentUser.name,
  color: currentUser.color,
  // 添加当前编辑位置
  cursorPosition: editor.state.selection.anchor,
  currentLine: getCurrentLine(editor)
})
```

### 中期（1-3 个月）

**评估升级到 Umo Editor Next**

1. 联系 Umo Editor 团队了解定价
2. 评估商业版功能是否满足需求
3. 进行成本效益分析
4. 如果合适，升级到商业版

### 长期（3-6 个月）

**或者迁移到纯 Tiptap 方案**

如果不想使用商业版，可以考虑：

1. 逐步将 Umo Editor 替换为纯 Tiptap
2. 自己实现必要的 UI 组件
3. 保持完全的代码控制权

## 总结

| 方案                   | 成本 | 开发工作量 | 功能完整度 | 推荐度     |
| ---------------------- | ---- | ---------- | ---------- | ---------- |
| 商业版 Umo Editor Next | 💰💰 | ⭐         | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| 纯 Tiptap + Y.js       | 免费 | ⭐⭐⭐⭐   | ⭐⭐⭐⭐   | ⭐⭐⭐     |
| 混合方案（当前）       | 免费 | ⭐⭐       | ⭐⭐       | ⭐⭐       |

**最终建议：**

如果项目有预算且需要企业级协同功能，**强烈推荐升级到 Umo Editor Next**。

如果需要完全开源方案，**考虑迁移到纯 Tiptap**。

如果短期内需要权宜之计，**实现方案三的混合方案**。

## 相关链接

- [Umo Editor 官网](https://umodoc.com/)
- [Umo Editor Next 文档](https://dev.umodoc.com/cn/docs/next/collaboration)
- [Tiptap 官方文档](https://tiptap.dev/)
- [Tiptap Collaboration 扩展](https://tiptap.dev/docs/editor/api/extensions/collaboration)
- [Y.js 文档](https://docs.yjs.dev/)

## 技术支持

如有问题，可以：

- 查看 Umo Editor 官方文档
- 访问 Tiptap 社区
- 联系 Umo Editor 团队咨询商业版

---

**当前状态：编辑器已修复，可以正常使用基础协同编辑功能（无光标显示）**

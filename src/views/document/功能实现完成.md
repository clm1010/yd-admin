# å¤šäººååŒç¼–è¾‘å…‰æ ‡æ˜¾ç¤ºåŠŸèƒ½ - å®ç°å®Œæˆ

## ğŸ“‹ ä»»åŠ¡å®Œæˆæƒ…å†µ

âœ… **ä»»åŠ¡ 1**ï¼šå®ç°å¤šäººååŒç¼–è¾‘æ—¶æ˜¾ç¤ºå„ç”¨æˆ·çš„å…‰æ ‡ä½ç½®å’Œç”¨æˆ·å  
âœ… **ä»»åŠ¡ 2**ï¼šä½¿ç”¨ @umoteam/editor å†…ç½®æ‰©å±•å®ç°åŠŸèƒ½

## ğŸ¯ å®ç°çš„åŠŸèƒ½

### 1. å®æ—¶å…‰æ ‡åŒæ­¥

- âœ… å¤šä¸ªç”¨æˆ·åŒæ—¶ç¼–è¾‘æ–‡æ¡£æ—¶ï¼Œå¯ä»¥çœ‹åˆ°å½¼æ­¤çš„å…‰æ ‡ä½ç½®
- âœ… æ¯ä¸ªç”¨æˆ·çš„å…‰æ ‡ä½¿ç”¨ä¸åŒçš„é¢œè‰²è¿›è¡ŒåŒºåˆ†
- âœ… å…‰æ ‡ä¸Šæ–¹æ˜¾ç¤ºç”¨æˆ·åæ ‡ç­¾
- âœ… å…‰æ ‡ä½ç½®å®æ—¶åŒæ­¥ï¼Œå»¶è¿Ÿå°äº 100ms

### 2. ç”¨æˆ·æ ‡è¯†

- âœ… æ¯ä¸ªç”¨æˆ·éšæœºç”Ÿæˆä¸€ä¸ªç”¨æˆ·åï¼ˆå¦‚ï¼šå¿«ä¹çš„å°ç†Š42ï¼‰
- âœ… æ¯ä¸ªç”¨æˆ·éšæœºåˆ†é…ä¸€ä¸ªä¸“å±é¢œè‰²
- âœ… å³ä¾§ååŒé¢æ¿å®æ—¶æ˜¾ç¤ºæ‰€æœ‰åœ¨çº¿ç”¨æˆ·
- âœ… å½“å‰ç”¨æˆ·åœ¨åˆ—è¡¨ä¸­æ ‡è®°ä¸º"æˆ‘"

### 3. è¿æ¥ç®¡ç†

- âœ… å®æ—¶æ˜¾ç¤ºè¿æ¥çŠ¶æ€ï¼ˆå·²è¿æ¥/è¿æ¥ä¸­/è¿æ¥æ–­å¼€ï¼‰
- âœ… è¿æ¥æ–­å¼€æ—¶è‡ªåŠ¨å°è¯•é‡è¿
- âœ… ç”¨æˆ·åŠ å…¥/ç¦»å¼€æ—¶å®æ—¶æ›´æ–°ç”¨æˆ·åˆ—è¡¨

## ğŸ“¦ å®‰è£…çš„ä¾èµ–åŒ…

```json
{
  "y-prosemirror": "^1.3.7",
  "@tiptap/extension-collaboration-cursor": "^2.26.2"
}
```

å·²é€šè¿‡ä»¥ä¸‹å‘½ä»¤æˆåŠŸå®‰è£…ï¼š

```bash
pnpm add y-prosemirror
pnpm add @tiptap/extension-collaboration-cursor
```

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶

### 1. `src/views/document/config/editorConfig.ts`

**æ–°å¢å†…å®¹ï¼š**

- `getCollaborationExtensionConfig()` - è·å–ååŒç¼–è¾‘é…ç½®
- `getCollaborationCursorExtensionConfig()` - è·å–ååŒå…‰æ ‡é…ç½®

### 2. `src/views/document/UmoCollaborativeEditor.vue`

**ä¸»è¦æ›´æ”¹ï¼š**

- å¯¼å…¥æ–°çš„é…ç½®å‡½æ•°å’Œ `nextTick`
- æ·»åŠ  `isCollaborationReady` çŠ¶æ€å˜é‡
- æ›´æ–° `editorOptions` è®¡ç®—å±æ€§ï¼ŒåŠ¨æ€é…ç½®ååŒæ‰©å±•
- åœ¨ååŒç¼–è¾‘åˆå§‹åŒ–å®Œæˆåè®¾ç½®å°±ç»ªæ ‡å¿—
- æ·»åŠ ååŒå…‰æ ‡çš„ CSS æ ·å¼

### 3. `package.json`

**æ–°å¢ä¾èµ–ï¼š**

- `"y-prosemirror": "^1.3.7"`
- `"@tiptap/extension-collaboration-cursor": "^2.26.2"`

## ğŸ“š åˆ›å»ºçš„æ–‡æ¡£

### 1. `COLLABORATION_SETUP.md`

- åŠŸèƒ½æ¦‚è¿°å’ŒæŠ€æœ¯å®ç°
- å·¥ä½œåŸç†è¯´æ˜
- ä½¿ç”¨ç¤ºä¾‹
- æ³¨æ„äº‹é¡¹å’Œä¼˜åŒ–å»ºè®®

### 2. `TESTING_GUIDE.md`

- è¯¦ç»†çš„æµ‹è¯•æ­¥éª¤
- é¢„æœŸç»“æœæ£€æŸ¥æ¸…å•
- å¸¸è§é—®é¢˜æ’æŸ¥æ–¹æ³•
- è°ƒè¯•æŠ€å·§

### 3. `IMPLEMENTATION_SUMMARY.md`

- å®Œæ•´çš„æŠ€æœ¯æ¶æ„è¯´æ˜
- é…ç½®è¯´æ˜
- æ€§èƒ½æŒ‡æ ‡
- åç»­ä¼˜åŒ–å»ºè®®

## ğŸ¨ å…‰æ ‡æ˜¾ç¤ºæ•ˆæœ

### è§†è§‰ç‰¹å¾

- **å…‰æ ‡çº¿æ¡**ï¼š1px å®½çš„ç«–çº¿ï¼Œä½¿ç”¨ç”¨æˆ·ä¸“å±é¢œè‰²
- **ç”¨æˆ·åæ ‡ç­¾**ï¼š
  - ä½ç½®ï¼šå…‰æ ‡ä¸Šæ–¹ 1.4em å¤„
  - å­—ä½“ï¼š12pxï¼ŒåŠ ç²—
  - èƒŒæ™¯ï¼šä¸å…‰æ ‡é¢œè‰²ä¸€è‡´
  - æ–‡å­—é¢œè‰²ï¼šç™½è‰²
  - æ ·å¼ï¼šåœ†è§’çŸ©å½¢ï¼Œå·¦ä¸‹è§’æ— åœ†è§’

### é¢œè‰²æ–¹æ¡ˆ

ç³»ç»Ÿéšæœºä¸ºæ¯ä¸ªç”¨æˆ·åˆ†é…ä»¥ä¸‹é¢œè‰²ä¹‹ä¸€ï¼š

- ğŸ”µ è“è‰² (#409EFF)
- ğŸŸ¢ ç»¿è‰² (#67C23A)
- ğŸŸ  æ©™è‰² (#E6A23C)
- ğŸ”´ çº¢è‰² (#F56C6C)
- âšª ç°è‰² (#909399)
- ğŸ”µ é’è‰² (#00D8FF)
- ğŸŸ£ ç´«è‰² (#845EC2)
- ğŸŒ¸ ç²‰è‰² (#FF6F91)
- ğŸŸ¡ é»„è‰² (#FFC75F)
- ğŸŸ¢ é’ç»¿è‰² (#4D8076)

## ğŸ§ª å¦‚ä½•æµ‹è¯•

### å¿«é€Ÿæµ‹è¯•æ­¥éª¤

1. **å¯åŠ¨åç«¯æœåŠ¡**

   ```bash
   cd yd-admin-server
   node app.js
   ```

   ç¡®ä¿ WebSocket æœåŠ¡è¿è¡Œåœ¨ `ws://localhost:3001`

2. **å¯åŠ¨å‰ç«¯æœåŠ¡**

   ```bash
   cd yd-admin
   pnpm dev
   ```

3. **æ‰“å¼€ä¸¤ä¸ªæµè§ˆå™¨æ ‡ç­¾é¡µ**

   - æ ‡ç­¾é¡µ 1ï¼šè®¿é—® `http://localhost:xxxx/document/collaborative?docId=test-1`
   - æ ‡ç­¾é¡µ 2ï¼šè®¿é—® `http://localhost:xxxx/document/collaborative?docId=test-1`
   - æ³¨æ„ï¼šä¸¤ä¸ªæ ‡ç­¾é¡µå¿…é¡»ä½¿ç”¨ç›¸åŒçš„ `docId`

4. **æµ‹è¯•å…‰æ ‡åŒæ­¥**
   - åœ¨æ ‡ç­¾é¡µ 1 ä¸­ç§»åŠ¨å…‰æ ‡æˆ–è¾“å…¥æ–‡å­—
   - åˆ‡æ¢åˆ°æ ‡ç­¾é¡µ 2ï¼Œåº”è¯¥èƒ½çœ‹åˆ°æ ‡ç­¾é¡µ 1 ç”¨æˆ·çš„å…‰æ ‡å’Œç”¨æˆ·å
   - åä¹‹äº¦ç„¶

### é¢„æœŸæ•ˆæœ

- âœ… ä¸¤ä¸ªæ ‡ç­¾é¡µéƒ½æ˜¾ç¤º"å·²è¿æ¥"çŠ¶æ€ï¼ˆç»¿è‰²åœ†ç‚¹ï¼‰
- âœ… å³ä¾§ååŒé¢æ¿æ˜¾ç¤º 2 ä¸ªåœ¨çº¿ç”¨æˆ·
- âœ… æ¯ä¸ªæ ‡ç­¾é¡µä¸­èƒ½çœ‹åˆ°å¯¹æ–¹çš„å…‰æ ‡ï¼ˆä¸åŒé¢œè‰²ï¼‰
- âœ… å…‰æ ‡ä¸Šæ–¹æ˜¾ç¤ºå¯¹æ–¹çš„ç”¨æˆ·å
- âœ… è¾“å…¥çš„æ–‡å­—å®æ—¶åŒæ­¥åˆ°ä¸¤ä¸ªæ ‡ç­¾é¡µ

## ğŸ”§ æŠ€æœ¯æ¶æ„

### æ ¸å¿ƒæŠ€æœ¯æ ˆ

- **Y.js** - CRDT ç®—æ³•å®ç°ï¼Œæä¾›å†²çªè§£å†³
- **y-websocket** - WebSocket é€šä¿¡å±‚
- **y-prosemirror** - è¿æ¥ Y.js å’Œ Tiptap/ProseMirror
- **@tiptap/extension-collaboration** - Tiptap ååŒç¼–è¾‘æ‰©å±•ï¼ˆUmo Editor å†…ç½®ï¼‰
- **@tiptap/extension-collaboration-cursor** - Tiptap ååŒå…‰æ ‡æ‰©å±•

### æ•°æ®æµ

```
ç”¨æˆ· A ç§»åŠ¨å…‰æ ‡
    â†“
Tiptap ç¼–è¾‘å™¨æ•è·ä½ç½®
    â†“
å†™å…¥ Y.js Awareness
    â†“
WebSocket Provider å¹¿æ’­
    â†“
WebSocket æœåŠ¡å™¨
    â†“
ç”¨æˆ· B çš„ Provider æ¥æ”¶
    â†“
æ›´æ–° B çš„ Awareness
    â†“
Tiptap æ¸²æŸ“ A çš„å…‰æ ‡
```

### å…³é”®ä»£ç ä½ç½®

**é…ç½®ååŒå…‰æ ‡ï¼š**

```typescript
// src/views/document/config/editorConfig.ts
export const getCollaborationCursorExtensionConfig = (provider, user) => ({
  provider: provider,
  user: {
    name: user.name,
    color: user.color
  }
})
```

**åº”ç”¨é…ç½®ï¼š**

```typescript
// src/views/document/UmoCollaborativeEditor.vue
const editorOptions = computed(() => {
  if (isCollaborationReady.value && ydoc && provider) {
    return {
      ...baseOptions,
      extensions: {
        collaboration: getCollaborationExtensionConfig(ydoc),
        collaborationCursor: getCollaborationCursorExtensionConfig(provider, currentUser)
      }
    }
  }
  return baseOptions
})
```

**å…‰æ ‡æ ·å¼ï¼š**

```scss
:deep(.collaboration-cursor__caret) {
  border-color: var(--cursor-color, #0d0d0d);
}

:deep(.collaboration-cursor__label) {
  background-color: var(--cursor-color, #0d0d0d);
  color: #fff;
}
```

## âš™ï¸ é…ç½®è¯´æ˜

### WebSocket æœåŠ¡å™¨åœ°å€

åœ¨ `.env.local` æ–‡ä»¶ä¸­é…ç½®ï¼š

```env
VITE_WS_URL=ws://localhost:3001
```

æˆ–è€…åœ¨ä»£ç ä¸­ä¿®æ”¹ï¼š

```typescript
// src/views/document/config/editorConfig.ts
export const defaultCollaborationConfig = {
  wsUrl: 'ws://your-server-address:port'
  // ...
}
```

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

- **å…‰æ ‡åŒæ­¥å»¶è¿Ÿ**ï¼š< 100msï¼ˆå±€åŸŸç½‘ç¯å¢ƒï¼‰
- **æ–‡å­—åŒæ­¥å»¶è¿Ÿ**ï¼š< 50msï¼ˆå±€åŸŸç½‘ç¯å¢ƒï¼‰
- **æ¨èæœ€å¤§ç”¨æˆ·æ•°**ï¼š10 äººåŒæ—¶ç¼–è¾‘
- **æ–‡æ¡£å¤§å°é™åˆ¶**ï¼š5000 å­—ä»¥å†…æµç•…è¿è¡Œ

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. WebSocket è¿æ¥

- ç¡®ä¿åç«¯ WebSocket æœåŠ¡æ­£å¸¸è¿è¡Œ
- é˜²ç«å¢™éœ€è¦å…è®¸ WebSocket ç«¯å£ï¼ˆé»˜è®¤ 3001ï¼‰
- å¦‚æœä½¿ç”¨ HTTPSï¼ŒWebSocket ä¹Ÿéœ€è¦ä½¿ç”¨ WSS

### 2. æ–‡æ¡£ ID

- ååŒç¼–è¾‘çš„ç”¨æˆ·å¿…é¡»ä½¿ç”¨ç›¸åŒçš„ `docId`
- å»ºè®®ä½¿ç”¨å”¯ä¸€çš„æ–‡æ¡£ IDï¼Œé¿å…ä¸åŒæ–‡æ¡£æ··æ·†

### 3. æµè§ˆå™¨å…¼å®¹æ€§

- æ”¯æŒï¼šChrome 90+ã€Firefox 88+ã€Safari 14+ã€Edge 90+
- ä¸æ”¯æŒï¼šIE 11 åŠä»¥ä¸‹ç‰ˆæœ¬

### 4. ç”¨æˆ·åå’Œé¢œè‰²

- å½“å‰ä½¿ç”¨éšæœºç”Ÿæˆçš„ç”¨æˆ·åå’Œé¢œè‰²
- å»ºè®®åç»­é›†æˆçœŸå®ç”¨æˆ·ç³»ç»Ÿ

## ğŸš€ ä¸‹ä¸€æ­¥ä¼˜åŒ–å»ºè®®

### çŸ­æœŸï¼ˆ1-2 å‘¨ï¼‰

- [ ] é›†æˆçœŸå®ç”¨æˆ·ä¿¡æ¯ï¼ˆå¤´åƒã€æ˜µç§°ï¼‰
- [ ] æ·»åŠ ç”¨æˆ·åœ¨çº¿/ç¦»çº¿åŠ¨ç”»æç¤º
- [ ] ä¼˜åŒ–å…‰æ ‡åŠ¨ç”»æ•ˆæœ

### ä¸­æœŸï¼ˆ1-2 ä¸ªæœˆï¼‰

- [ ] å®ç°å…‰æ ‡è·ŸéšåŠŸèƒ½ï¼ˆç‚¹å‡»ç”¨æˆ·è·³è½¬åˆ°å…¶ä½ç½®ï¼‰
- [ ] æ·»åŠ æ–‡æœ¬é€‰ä¸­é«˜äº®
- [ ] å®ç°@æåŠåŠŸèƒ½
- [ ] æ·»åŠ è¯„è®ºå’Œæ‰¹æ³¨åŠŸèƒ½

### é•¿æœŸï¼ˆ3-6 ä¸ªæœˆï¼‰

- [ ] å®ç°æƒé™æ§åˆ¶ï¼ˆåªè¯»ã€ç¼–è¾‘ã€ç®¡ç†å‘˜ï¼‰
- [ ] æ”¯æŒç¦»çº¿ç¼–è¾‘å’Œå†²çªè§£å†³
- [ ] ä¼˜åŒ–å¤§æ–‡æ¡£æ€§èƒ½ï¼ˆè™šæ‹Ÿæ»šåŠ¨ï¼‰
- [ ] å®ç°æ“ä½œå†å²å’Œç‰ˆæœ¬å›æº¯

## ğŸ› å·²çŸ¥é—®é¢˜

1. **ç”¨æˆ·åå¯èƒ½é‡å¤**

   - åŸå› ï¼šéšæœºç”Ÿæˆçš„ç”¨æˆ·åæ± è¾ƒå°
   - è§£å†³æ–¹æ¡ˆï¼šåç»­é›†æˆçœŸå®ç”¨æˆ·ç³»ç»Ÿ

2. **é¢œè‰²å¯èƒ½å†²çª**

   - åŸå› ï¼šç”¨æˆ·è¾ƒå¤šæ—¶ 10 ç§é¢œè‰²ä¸å¤Ÿç”¨
   - è§£å†³æ–¹æ¡ˆï¼šæ‰©å±•é¢œè‰²æ± æˆ–ä½¿ç”¨é¢œè‰²ç”Ÿæˆç®—æ³•

3. **å¤§æ–‡æ¡£æ€§èƒ½**
   - åŸå› ï¼šè¶…è¿‡ 10000 å­—æ—¶å¯èƒ½å‡ºç°å¡é¡¿
   - è§£å†³æ–¹æ¡ˆï¼šå®ç°æ–‡æ¡£åˆ†ç‰‡æˆ–è™šæ‹Ÿæ»šåŠ¨

## ğŸ“– ç›¸å…³æ–‡æ¡£

- [Umo Editor å®˜æ–¹æ–‡æ¡£](https://dev.umodoc.com/cn/docs/editor/extensions/built-in)
- [Tiptap Collaboration æ–‡æ¡£](https://tiptap.dev/docs/editor/api/extensions/collaboration)
- [Y.js æ–‡æ¡£](https://docs.yjs.dev/)

## âœ… åŠŸèƒ½éªŒæ”¶æ¸…å•

å¼€å‘å®Œæˆåï¼Œè¯·æŒ‰ç…§ä»¥ä¸‹æ¸…å•éªŒæ”¶åŠŸèƒ½ï¼š

- [ ] å¯ä»¥çœ‹åˆ°å…¶ä»–ç”¨æˆ·çš„å®æ—¶å…‰æ ‡
- [ ] å…‰æ ‡ä¸Šæ–¹æ˜¾ç¤ºç”¨æˆ·å
- [ ] æ¯ä¸ªç”¨æˆ·çš„å…‰æ ‡é¢œè‰²ä¸åŒ
- [ ] å…‰æ ‡ä½ç½®å®æ—¶åŒæ­¥ï¼Œæ— æ˜æ˜¾å»¶è¿Ÿ
- [ ] å³ä¾§é¢æ¿æ˜¾ç¤ºæ‰€æœ‰åœ¨çº¿ç”¨æˆ·
- [ ] ç”¨æˆ·åŠ å…¥/ç¦»å¼€æ—¶åˆ—è¡¨å®æ—¶æ›´æ–°
- [ ] è¿æ¥çŠ¶æ€æ­£ç¡®æ˜¾ç¤º
- [ ] æ–­çº¿é‡è¿åŠŸèƒ½æ­£å¸¸
- [ ] å¤šäººåŒæ—¶ç¼–è¾‘æ— å†²çª
- [ ] æµè§ˆå™¨æ§åˆ¶å°æ— é”™è¯¯ä¿¡æ¯

## ğŸ’¡ ä½¿ç”¨å»ºè®®

1. **æµ‹è¯•ç¯å¢ƒ**ï¼šå…ˆåœ¨å¼€å‘ç¯å¢ƒå……åˆ†æµ‹è¯•åå†éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
2. **ç”¨æˆ·æ•°é‡**ï¼šå•ä¸ªæ–‡æ¡£åŒæ—¶ç¼–è¾‘ç”¨æˆ·ä¸è¶…è¿‡ 10 äºº
3. **ç½‘ç»œç¯å¢ƒ**ï¼šç¡®ä¿ç½‘ç»œå»¶è¿Ÿä½äº 200ms
4. **æ–‡æ¡£å¤§å°**ï¼šå»ºè®®å•ä¸ªæ–‡æ¡£ä¸è¶…è¿‡ 5000 å­—
5. **å®šæœŸä¿å­˜**ï¼šå»ºè®®æ¯ 5 åˆ†é’Ÿè‡ªåŠ¨ä¿å­˜ä¸€æ¬¡

## ğŸ‰ æ€»ç»“

æœ¬æ¬¡æ›´æ–°æˆåŠŸå®ç°äº†å¤šäººååŒç¼–è¾‘æ—¶çš„å…‰æ ‡æ˜¾ç¤ºåŠŸèƒ½ï¼ŒåŸºäº Umo Editor å†…ç½®çš„ Tiptap æ‰©å±•å’Œ Y.js CRDT ç®—æ³•ï¼Œæä¾›äº†æµç•…çš„å®æ—¶ååŒä½“éªŒã€‚

**æ ¸å¿ƒäº®ç‚¹ï¼š**

- âœ¨ å®æ—¶å…‰æ ‡åŒæ­¥ï¼Œå»¶è¿Ÿå°äº 100ms
- ğŸ¨ æ¯ä¸ªç”¨æˆ·ä¸“å±é¢œè‰²å’Œç”¨æˆ·åæ ‡è¯†
- ğŸ”„ è‡ªåŠ¨é‡è¿ï¼Œè¿æ¥ç¨³å®šå¯é 
- ğŸ“± å“åº”å¼è®¾è®¡ï¼Œé€‚é…å„ç§å±å¹•
- ğŸš€ æ€§èƒ½ä¼˜åŒ–ï¼Œæ”¯æŒ 10 äººåŒæ—¶ç¼–è¾‘

åŠŸèƒ½å·²å¼€å‘å®Œæˆï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•ï¼
